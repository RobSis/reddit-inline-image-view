// ==UserScript==
// @name           reddit-inline-image-view
// @namespace      reddit_image_expando
// @updateURL      https://github.com/RobSis/reddit-inline-image-view/blob/master/reddit-inline-image-view.user.js
// @description    Shows directly linked images or imgur images in the current page.
// @version        1.0
// @require        https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js
// @include        http://www.reddit.com/*
// @exclude        http://www.reddit.com/ads/*
// ==/UserScript==
function getDragSize(e){return(p=Math.pow)(Math.pow(e.clientX-(rc=e.target.getBoundingClientRect()).left,2)+Math.pow(e.clientY-rc.top,2),.5)}function getHeight(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}function makeImageZoomable(e){var t={};e.addEventListener("mousedown",function(e){return 0!=e.ctrlKey?!0:null!=e.metaKey&&0!=e.metaKey?!0:void(0==e.button&&(t.width=e.target.width,t.delta=getDragSize(e),t.dragging=!0,e.preventDefault()))},!0),e.addEventListener("contextmenu",function(e){return 0!=imageData[e.target].resized?(imageData[e.target].resized=0,e.target.style.zIndex=imageData[e.target].zIndex,e.target.style.maxWidth=e.target.style.width=imageData[e.target].width,e.target.style.maxHeight=e.target.style.height=imageData[e.target].height,e.target.style.position=imageData[e.target].position,e.preventDefault(),e.returnValue=!1,e.stopPropagation(),!1):!0},!0),e.addEventListener("mousemove",function(e){if(t.dragging){var a=Math.abs(t.delta-getDragSize(e));if(a>5){var i=parseInt(e.target.style.width.replace("px",""),10);e.target.style.maxWidth=e.target.style.width=Math.floor(getDragSize(e)*t.width/t.delta)+"px",e.target.style.maxHeight="",e.target.style.height="auto",e.target.style.zIndex=1e3,""==e.target.style.position&&(e.target.style.position="relative"),imageData[e.target].resized=i-parseInt(e.target.style.width.replace("px",""),10)}}},!1),e.addEventListener("mouseout",function(e){return t.dragging?(t.dragging=!1,e.preventDefault(),!1):!0},!0),e.addEventListener("mouseup",function(e){return t.dragging?(t.dragging=!1,e.preventDefault(),!1):!0},!0),e.addEventListener("click",function(e){return 0!=e.ctrlKey?!0:null!=e.metaKey&&0!=e.metaKey?!0:isNaN(imageData[e.target].resized)||0==imageData[e.target].resized?!0:(e.preventDefault(),!1)},!0)}function viewImage(e,t){if(e.hasClass("rixImageLink")&&e.hasClass("collapsed")){var a=e.attr("href"),i=a.indexOf("imgur.")>=0&&a.indexOf(".jpg")<0&&a.indexOf(".png")<0&&a.indexOf(".gif")<0?".jpg":"",n=document.createElement("img");e.attr("class","rixImageLink expanded"),n.setAttribute("class","rixExpandedImage"),n.setAttribute("style","display:block;max-width:500px;"),n.setAttribute("src",a+i),imageData[n]={zindex:n.style.zIndex,width:n.style.width,height:n.style.height,position:n.style.position,resized:0,resizable:!0},makeImageZoomable(n),t?e.next(".rixButton").after(n):e.parent().parent().append(n)}}function hideImage(e){e.attr("class","rixImageLink collapsed"),e.parent().parent().find(".rixExpandedImage").remove()}function viewImages(e,t){$(".content").find(e).each(function(){viewImage($(this),t)})}function hideImages(e){$(".content").find(e).each(function(){hideImage($(this))})}function injectExpandos(e,t){{var a=0;$(".content").find(e).each(function(){{var e=$(this),i=e.attr("href");e.text()}if(!e.hasClass(".rixImageLink")&&i&&(i.indexOf("imgur.")>=0&&i.indexOf("/a/")<0&&i.indexOf("/gallery/")<0||i.indexOf(".jpeg")>=0||i.indexOf(".jpg")>=0||i.indexOf(".gif")>=0||i.indexOf(".png")>=0)){e.attr("class","rixImageLink collapsed"),a+=1;var n=document.createElement("div");n.setAttribute("class",BUTTON_COLLAPSED_CLASS),n.addEventListener("click",function(){n.className.indexOf("collapsed")>0?(n.setAttribute("class",BUTTON_EXPANDED_CLASS),viewImage(e,t)):(n.setAttribute("class",BUTTON_COLLAPSED_CLASS),hideImage(e))},!0),t?(n.setAttribute("style",BUTTON_COMMENT_STYLE),e.after(n)):e.parent().after(n)}})}return a}function expandButtons(e){$(".content").find(e).each(function(){$(this).hasClass("collapsed")&&$(this).attr("class",BUTTON_EXPANDED_CLASS)})}function collapseButtons(e){$(".content").find(e).each(function(){$(this).hasClass("expanded")&&$(this).attr("class",BUTTON_COLLAPSED_CLASS)})}var BUTTON_EXPANDED_CLASS="expando-button expanded selftext rixButton",BUTTON_COLLAPSED_CLASS="expando-button collapsed selftext rixButton",BUTTON_COMMENT_STYLE="vertical-align:top !important; float: none; width: 23px; height: 23px;max-width: 23px; max-height: 23px; display: inline-block;margin-right: 6px; cursor: pointer;  padding: 0px;",imageData=[];!function(){var e=0;e+=injectExpandos("#siteTable div.entry p.title a.title",!1),e+=injectExpandos(".usertext-body .md p a",!0);for(var t=" ("+e+")",a=document.getElementById("header-bottom-left"),i=a.getElementsByTagName("ul"),n=null,r=0;r<i.length;r++)"tabmenu "==i[r].className&&(n=i[r]);if(null!=n){var s=document.createElement("li"),d=document.createElement("a"),l=document.createTextNode("view images"+t);d.setAttribute("class","rixViewAll"),d.setAttribute("href","javascript:void(0);"),d.addEventListener("click",function(){d.classList.contains("rixViewAll")?(d.setAttribute("class","rixHideAll"),l.nodeValue="hide images"+t,viewImages("#siteTable div.entry p.title a",!1),viewImages(".usertext-body div.md p a",!0),expandButtons(".rixButton")):(d.setAttribute("class","rixViewAll"),l.nodeValue="view images"+t,hideImages("#siteTable div.entry p.title a"),hideImages(".usertext-body div.md p a"),collapseButtons(".rixButton"))},!1),d.appendChild(l),s.appendChild(d),n.appendChild(s)}document.addEventListener("dragstart",function(){return!1},!1)}();
